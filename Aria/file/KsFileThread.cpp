/************************************************************************************************/
/** 
 * @file		KsFileThread.cpp
 * @brief		ファイルスレッド
 * @author		A567W
 * @date		2011/07/02
 * @since		2011/07/02
 * @version		1.0.0
 */
/************************************************************************************************/

/*==============================================================================================*/
/*                                 << インクルード >>                                           */
/*==============================================================================================*/
#include "KsFileSystem.h"
#include "KsFileThread.h"

/*==============================================================================================*/
/*                                     << 定義 >>                                               */
/*==============================================================================================*/

/*==============================================================================================*/
/*                                     << 宣言 >>                                               */
/*==============================================================================================*/

ksNS_KS_BEGIN

/************************************************************************************************/
/*
 * ファイルスレッド生成
 */
/************************************************************************************************/
KsFileThread::KsFileThread( KsFileSystem* pFileSystem, ksTHREAD_PRIORITY_TYPE priority, KsUInt32 prosessor )
	: m_pFileThread( ksNULLPTR )
    , m_pFileSystem( pFileSystem )
	, m_priority( priority )
	, m_prosessor( prosessor )
	, m_bThreadLoop( ksFALSE )
{
}

/************************************************************************************************/
/*
 * デストラクタ
 */
/************************************************************************************************/
KsFileThread::~KsFileThread()
{
	// 終了させる
	m_bThreadLoop = ksFALSE;

	// スレッド終了待ちする
	m_pFileThread->join();

    ksDELETE( m_pFileThread );
}

/************************************************************************************************/
/*
 * ファイルスレッドの処理を開始する。
 */
/************************************************************************************************/
KsBool KsFileThread::run()
{
	m_bThreadLoop = ksTRUE;

	/* スレッド開始する */
    m_pFileThread = ksNew KsThread( &KsFileThread::workerFunc, this );

	return ksTRUE;
}

/************************************************************************************************/
/*
 * 同期まちをする
 */
/************************************************************************************************/
KsUInt32 KsFileThread::workerFunc()
{
    KsHandle handle = m_pFileThread->native_handle();

	KsThreadUtil::setPriority( handle, m_priority );
	KsThreadUtil::setProcessor( handle, m_prosessor );
	
	/* ゲームループ */
	while( m_bThreadLoop )
	{
        m_waitEvent.wait();
	
		m_pFileSystem->lock();
		
		m_pFileSystem->polling();
		
		m_pFileSystem->unlock();

		KsThreadUtil::yield();
	}

	return 0;
}

/************************************************************************************************/
/*
 * ウエイトイベントをセットする
 */
/************************************************************************************************/
void KsFileThread::setWaitEvent()
{
	// ウエイトイベントをセットする
	m_waitEvent.signale();
}

/************************************************************************************************/
/*
 * 同期イベントをセットする
 */
/************************************************************************************************/
void KsFileThread::setSyncEvent()
{
	// 同期イベントをセットする
    m_syncEvent.signale();
}

/************************************************************************************************/
/*
 * ウエイトイベントをリセットする
 */
/************************************************************************************************/
void KsFileThread::resetWaitEvent()
{
	// ウエイトイベントをリセットする
    m_waitEvent.reset();
}

/************************************************************************************************/
/*
 * 同期イベントをリセットする
 */
/************************************************************************************************/
void KsFileThread::resetSyncEvent()
{
	// 同期イベントをリセットする
    m_syncEvent.reset();
}


ksNS_KS_END

